<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application de Correction</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
            background: #f5f5f5; /* Fond gris neutre au lieu du d√©grad√© mauve */
            min-height: 100vh;
            padding: 20px 20px 0 20px; /* Suppression du padding-bottom */
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .selection-section {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%); /* Bleu fonc√© au lieu du bleu clair */
            z-index: 100;
            box-shadow: 0 6px 20px rgba(26, 35, 126, 0.3);
            border-bottom: 4px solid #1a237e;
            margin: 0;
            padding: 35px 40px 25px; /* R√©duit le padding-bottom */
            min-height: 140px; /* Hauteur minimum garantie */
        }

        .selection-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 40px;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            color: white; /* Labels en blanc pour contraster avec le fond fonc√© */
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        #pointsTotalFixe {
            background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%) !important;
            color: white !important;
            padding: 20px 30px !important;
            border-radius: 15px !important;
            text-align: center !important;
            box-shadow: 0 8px 25px rgba(26, 115, 232, 0.4) !important;
            min-width: 180px !important;
            transform: scale(1) !important;
            transition: transform 0.2s ease !important;
        }

        #pointsTotalFixe * {
            color: white !important;
        }

        #pointsTotalValeur {
            font-size: 32px !important;
            font-weight: 700 !important;
            display: block !important;
            margin-bottom: 8px !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
            transition: transform 0.2s ease !important;
            color: white !important;
        }

        #pointsTotalFixe .points-label {
            font-size: 13px !important;
            opacity: 0.9 !important;
            text-transform: uppercase !important;
            letter-spacing: 1.5px !important;
            font-weight: 500 !important;
            color: white !important;
        }

        .grille-section {
            margin-top: 200px; /* Augment√© de 160px √† 200px pour compenser */
            padding-top: 50px; /* Augment√© de 30px √† 50px pour plus d'espace */
        }

        .save-section {
            margin-top: 0; /* R√©duction de l'espace entre grille et save */
            padding-top: 20px; /* Espacement r√©duit */
        }

        section {
            padding: 30px;
            border-bottom: 1px solid #e8eaed;
        }

        section:last-child {
            border-bottom: none;
        }

        h2 {
            color: #1a73e8;
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: 500;
        }

        .custom-select, .custom-input {
            padding: 12px 16px;
            border: 2px solid #dadce0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .custom-input {
            cursor: text;
        }

        .custom-select:focus, .custom-input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .custom-select:hover, .custom-input:hover {
            border-color: #1a73e8;
        }

        .btn-primary, .btn-success, .btn-secondary, .btn-warning {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #1a73e8;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1557b0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }

        .btn-primary:disabled {
            background: #dadce0;
            color: #5f6368;
            cursor: not-allowed;
        }

        .btn-success {
            background: #34a853;
            color: white;
            font-size: 16px;
            padding: 15px 30px;
        }

        .btn-success:hover {
            background: #2d7d2f;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 168, 83, 0.3);
        }

        .btn-secondary {
            background: #1565c0;
            color: white;
            font-size: 12px;
            padding: 10px 20px;
        }

        .btn-secondary:hover {
            background: #0d47a1;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(21, 101, 192, 0.3);
        }

        .btn-warning {
            background: #ff9800;
            color: white;
            font-size: 14px; /* M√™me taille que les autres boutons */
            padding: 12px 16px; /* M√™me padding que les inputs/selects */
            border-radius: 8px; /* M√™me border-radius */
        }

        .btn-warning:hover {
            background: #f57c00;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }

        /* Styles pour l'√©cran rideau de pr√©correction */
        .precorrection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .precorrection-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .precorrection-panel {
            position: fixed;
            top: 0;
            right: -50%;
            width: 50%;
            height: 100%;
            background: white;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.3);
            transition: right 0.4s ease;
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }

        .precorrection-panel.active {
            right: 0;
        }

        .precorrection-header {
            background: linear-gradient(135deg, #1565c0 0%, #1976d2 100%);
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .precorrection-header h3 {
            margin: 0;
            font-size: 1.3em;
            font-weight: 600;
        }

        .close-panel-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .close-panel-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .precorrection-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .copie-eleve-section {
            display: flex;
            flex-direction: column;
        }

        .copie-eleve-section label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #1565c0;
            font-size: 16px;
        }

        .copie-eleve-textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Georgia', serif;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.2s ease;
        }

        .copie-eleve-textarea:focus {
            outline: none;
            border-color: #1565c0;
            box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.1);
        }

        .precorrection-actions {
            display: flex;
            gap: 15px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .btn-precorrection {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-precorrection:hover {
            background: linear-gradient(135deg, #43a047 0%, #5cb85c 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-precorrection:disabled {
            background: #e0e0e0;
            color: #9e9e9e;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .precorrection-status {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
            text-align: center;
        }

        .precorrection-status.loading {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }

        .precorrection-status.success {
            background: #e8f5e8;
            color: #2d7d2f;
            border: 1px solid #81c784;
        }

        .precorrection-status.error {
            background: #fce8e6;
            color: #d93025;
            border: 1px solid #f28b82;
        }

        @media (max-width: 768px) {
            .precorrection-panel {
                width: 90%;
                right: -90%;
            }
        }

        .grille-container {
            display: grid;
            gap: 25px; /* Augment√© l'espacement entre les crit√®res */
            padding: 20px 0;
        }

        .critere-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); /* Fond d√©grad√© bleu-violet pour mise en √©vidence */
            border: 2px solid rgba(26, 115, 232, 0.2);
            border-radius: 16px; /* Coins plus arrondis */
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 15px; /* Marge suppl√©mentaire entre les blocs */
        }

        .critere-card:hover {
            box-shadow: 0 8px 25px rgba(26, 115, 232, 0.15);
            transform: translateY(-2px);
            border-color: rgba(26, 115, 232, 0.4);
        }

        .critere-header {
            background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%); /* En-t√™te avec d√©grad√© bleu */
            color: white;
            padding: 25px;
            border-bottom: none;
            position: relative;
        }

        .critere-nom {
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
            font-size: 16px;
            line-height: 1.4;
        }

        .critere-points {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            font-weight: 500;
        }

        .critere-score {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            color: #1a73e8;
            padding: 10px 15px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 14px;
            min-width: 70px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .critere-score.empty {
            background: rgba(255, 255, 255, 0.7);
            color: #666;
        }

        .indicateurs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.7); /* Fond semi-transparent pour les indicateurs */
        }

        .indicateur-btn {
            padding: 15px 12px;
            border: 2px solid #e8eaed;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            text-align: center;
            line-height: 1.3;
            position: relative;
            overflow: hidden;
        }

        .indicateur-btn:hover {
            border-color: #1a73e8;
            background: #f8f9ff;
        }

        .indicateur-btn.selected.niveau-faible {
            background: #f44336;
            color: white;
            border-color: #f44336;
            transform: scale(1.02);
        }

        .indicateur-btn.selected.niveau-bon {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
            transform: scale(1.02);
        }

        .commentaires-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e8eaed;
        }

        .commentaires-section h3 {
            margin-bottom: 15px;
            color: #1a73e8;
            font-size: 1.1em;
        }

        .commentaires-section textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dadce0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
        }

        .commentaires-section textarea:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .save-status {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
        }

        .save-status.success {
            background: #e8f5e8;
            color: #2d7d2f;
            border: 1px solid #81c784;
        }

        .save-status.error {
            background: #fce8e6;
            color: #d93025;
            border: 1px solid #f28b82;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e8eaed;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Styles pour le pied de page */
        .footer {
            margin-top: 50px;
            border-top: 3px solid #1a73e8;
            padding: 25px 40px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            position: relative;
            box-sizing: border-box;
        }

        .footer-left {
            font-weight: 600;
            color: #1a73e8;
            font-size: 14px;
        }

        .footer-center {
            font-weight: 500;
            color: #5f6368;
            font-size: 14px;
        }

        .footer-right {
            display: flex;
            align-items: center;
        }

        .footer-logo {
            height: 70px;
            width: auto;
            object-fit: contain;
        }

        @media (max-width: 768px) {
            .indicateurs-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            section {
                padding: 20px;
            }

            .selection-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .footer {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding: 20px;
            }

            .footer-logo {
                height: 35px;
            }
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="container">
        <!-- Section 1: S√©lection -->
        <section class="selection-section">
            <div class="selection-content">
                <div class="control-group">
                    <label for="eleveInput">√âl√®ve:</label>
                    <input type="text" 
                           id="eleveInput" 
                           class="custom-input" 
                           list="elevesList"
                           placeholder="Tapez ou s√©lectionnez un nom..."
                           autocomplete="off">
                    <datalist id="elevesList">
                        <!-- Les options seront ajout√©es dynamiquement -->
                    </datalist>
                </div>
                
                <div class="control-group">
                    <label for="productionSelect">Type de production:</label>
                    <select id="productionSelect" class="custom-select">
                        <option value="">Chargement...</option>
                    </select>
                </div>

                <!-- Score repositionn√© tout √† droite et en haut -->
                <div style="display: flex; flex-direction: column; align-items: flex-end; justify-content: flex-start;">
                    <div id="pointsTotalFixe" style="display: none; margin-bottom: 15px;">
                        <span id="pointsTotalValeur">0</span>
                        <span class="points-label">Points total</span>
                    </div>
                </div>
            </div>
            
            <!-- Ligne des boutons d'action principaux - NOUVELLE DISPOSITION -->
            <div style="max-width: 1200px; margin: 15px auto 0; display: flex; justify-content: space-between; align-items: center;">
                <!-- Groupe gauche: R√©initialisation + Sauvegarder -->
                <div style="display: flex; gap: 15px;">
                    <button id="btnReinitialisation" class="btn-warning">
                        üîÑ R√©initialisation
                    </button>
                    
                    <button id="btnSauvegarder" class="btn-warning">
                        üíæ Sauvegarder la correction
                    </button>
                </div>
                
                <!-- Groupe droite: Pr√©correction isol√©e -->
                <button id="btnPrecorrection" class="btn-warning">
                    üéØ Pr√©correction
                </button>
            </div>
        </section>

        <!-- Section 2: Grille de correction -->
        <section class="grille-section" id="grilleSection" style="display: none;">
            <div id="grilleContainer"></div>
            
            <!-- Zone de commentaires -->
            <div class="commentaires-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>üí¨ Commentaires personnalis√©s</h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="btnPropositionCommentaire" class="btn-warning">
                            üí° Proposition d'un commentaire
                        </button>
                        <button id="btnAmeliorationCommentaire" class="btn-warning">
                            ‚ú® Am√©lioration du commentaire
                        </button>
                    </div>
                </div>
                <textarea id="commentairesGeneraux" 
                         placeholder="Commentaires g√©n√©raux sur la production de l'√©l√®ve..."
                         rows="4"></textarea>
            </div>
        </section>

        <!-- Section 3: Enregistrement -->
        <section class="save-section" id="saveSection" style="display: none;">
            <!-- Messages persistants d'enregistrement -->
            <div id="saveStatus" class="save-status"></div>
        </section>
    </div>
    </div>

    <!-- Pied de page - MAINTENANT PERMANENT ET IND√âPENDANT -->
    <footer class="footer">
        <div class="footer-left">
            Version 1.5
        </div>
        <div class="footer-center">
            Juin 2025
        </div>
        <div class="footer-right">
            <img src="https://drive.google.com/thumbnail?id=17m5J5zlV1SrLhJeX8JBzK2QZMWwFgXgf&sz=w1000" 
                 alt="Logo" 
                 class="footer-logo"
                 onerror="this.style.display='none'">
        </div>
    </footer>

    <!-- √âcran rideau de pr√©correction IA -->
    <div id="precorrectionOverlay" class="precorrection-overlay">
        <div id="precorrectionPanel" class="precorrection-panel">
            <div class="precorrection-header">
                <h3>ü§ñ Pr√©correction IA</h3>
                <button class="close-panel-btn" id="closePrecorrectionPanel">√ó</button>
            </div>
            
            <div class="precorrection-content">
                <div class="copie-eleve-section">
                    <label for="copieEleveText">üìù Copie de l'√©l√®ve √† corriger :</label>
                    <textarea 
                        id="copieEleveText" 
                        class="copie-eleve-textarea"
                        placeholder="Collez ici le texte de la production de l'√©l√®ve √† faire corriger par l'IA...

Exemple : 
- R√©daction
- R√©ponses √† des questions
- Analyse de texte
- etc."></textarea>
                </div>
                
                <div class="precorrection-actions">
                    <button id="lancerPrecorrection" class="btn-precorrection">
                        üöÄ Lancer la pr√©correction IA
                    </button>
                </div>
                
                <div id="precorrectionStatus" class="precorrection-status" style="display: none;"></div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Chargement en cours...</p>
        </div>
    </div>


<script>
        let grilleData = null;
        let corrections = {};
        let pointsTotal = 0;
        let elevesData = [];
        let selectedEleve = '';

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM charg√©, initialisation...');
            initializeApp();
        });

        async function initializeApp() {
            console.log('üöÄ === D√âBUT INITIALISATION ===');
            
            try {
                console.log('Configuration des √©v√©nements...');
                setupEventListeners();
                
                console.log('üîÑ Tentative de chargement ultra-rapide...');
                showLoading(true);
                
                try {
                    await chargerToutEnUnCoup();
                    showLoading(false);
                    
                    const eleveInput = document.getElementById('eleveInput');
                    eleveInput.placeholder = "Tapez ou s√©lectionnez un nom...";
                    eleveInput.disabled = false;
                    
                    showSuccessDiscret('üöÄ Chargement ultra-rapide r√©ussi !');
                    console.log('‚úÖ Initialisation ultra-rapide termin√©e');
                    
                } catch (ultraError) {
                    console.warn('‚ö†Ô∏è Chargement ultra-rapide √©chou√©, mode progressif:', ultraError);
                    
                    console.log('üîÑ Chargement des types de production (prioritaire)...');
                    await chargerTypesProduction();
                    showLoading(false);
                    
                    console.log('‚úÖ Interface pr√™te ! Chargement des √©l√®ves en arri√®re-plan...');
                    chargerElevesEnArrierePlan();
                }
                
                console.log('üéâ Initialisation termin√©e avec succ√®s');
                
            } catch (error) {
                console.error('‚ùå Erreur d\'initialisation critique:', error);
                showLoading(false);
                
                let messageErreur = `Erreur lors du chargement: ${error.message || error.toString()}`;
                
                if (error.diagnostic) {
                    messageErreur += `\n\nDiagnostic: ${JSON.stringify(error.diagnostic, null, 2)}`;
                }
                
                showError(messageErreur);
                
                try {
                    console.log('üîß Tentative de chargement simplifi√©...');
                    setupEventListeners();
                    
                    const productionSelect = document.getElementById('productionSelect');
                    
                    if (productionSelect.children.length <= 1) {
                        productionSelect.innerHTML = `
                            <option value="">S√©lectionner un type</option>
                            <option value="Test Production">Test Production</option>
                        `;
                    }
                    
                    showError('Mode de test activ√© - fonctionnalit√©s limit√©es');
                } catch (fallbackError) {
                    console.error('‚ùå √âchec du chargement simplifi√©:', fallbackError);
                    showError('Impossible de charger l\'application. Veuillez rafra√Æchir la page.');
                }
            }
        }

        async function chargerElevesEnArrierePlan() {
            const eleveInput = document.getElementById('eleveInput');
            
            try {
                eleveInput.placeholder = "‚è≥ Chargement des √©l√®ves...";
                eleveInput.disabled = true;
                
                console.log('üîÑ Chargement des √©l√®ves en arri√®re-plan...');
                await chargerEleves();
                
                eleveInput.placeholder = "Tapez ou s√©lectionnez un nom...";
                eleveInput.disabled = false;
                console.log('‚úÖ √âl√®ves charg√©s avec succ√®s en arri√®re-plan');
                
                showSuccessDiscret(`‚úÖ ${elevesData.length} √©l√®ves charg√©s`);
                
            } catch (error) {
                console.error('‚ùå Erreur chargement √©l√®ves en arri√®re-plan:', error);
                
                eleveInput.placeholder = "‚ö†Ô∏è Tapez manuellement le nom de l'√©l√®ve";
                eleveInput.disabled = false;
                
                let message = '‚ö†Ô∏è Mode manuel pour les noms d\'√©l√®ves';
                if (error.message && error.message.includes('dataEleves')) {
                    message = '‚ö†Ô∏è Feuille "dataEleves" manquante - mode manuel activ√©';
                }
                
                showSuccessDiscret(message);
            }
        }

        async function chargerEleves() {
            try {
                console.log('üìû Appel backend: getEleves()');
                
                const eleves = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .getEleves();
                });
                
                console.log('üì® R√©ponse backend √©l√®ves:', eleves);
                
                if (!Array.isArray(eleves)) {
                    throw new Error('R√©ponse backend invalide: pas un tableau');
                }
                
                elevesData = eleves;
                
                const datalist = document.getElementById('elevesList');
                datalist.innerHTML = '';
                
                let elevesAjoutes = 0;
                eleves.forEach(eleve => {
                    if (eleve && eleve.nom && eleve.nom.trim() !== '') {
                        const option = document.createElement('option');
                        option.value = eleve.nom.trim();
                        datalist.appendChild(option);
                        elevesAjoutes++;
                    }
                });
                
                console.log(`‚úÖ ${elevesAjoutes} √©l√®ves ajout√©s au datalist`);
                
                if (elevesAjoutes === 0) {
                    throw new Error('Aucun √©l√®ve valide trouv√© dans les donn√©es');
                }
                
            } catch (error) {
                console.error('‚ùå Erreur chargement √©l√®ves:', error);
                throw error;
            }
        }

        async function chargerTypesProduction() {
            try {
                console.log('üìû Appel backend: getTypesProduction()');
                
                const types = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .getTypesProduction();
                });
                
                console.log('üì® R√©ponse backend types:', types);
                
                if (!Array.isArray(types)) {
                    throw new Error('R√©ponse backend invalide pour les types');
                }
                
                const select = document.getElementById('productionSelect');
                select.innerHTML = '<option value="">S√©lectionner un type</option>';
                
                types.forEach(type => {
                    if (type && type.trim() !== '') {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        select.appendChild(option);
                    }
                });
                
                console.log(`‚úÖ ${types.length} types de production charg√©s`);
                
            } catch (error) {
                console.error('‚ùå Erreur chargement types:', error);
                throw error;
            }
        }

        async function chargerToutEnUnCoup() {
            try {
                console.log('üìû Appel backend: getElevesEtTypes()');
                
                const donnees = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .getElevesEtTypes();
                });
                
                console.log('üì® R√©ponse backend compl√®te:', donnees);
                
                if (!donnees) {
                    throw new Error('Aucune r√©ponse du backend');
                }
                
                if (!donnees.success) {
                    console.error('‚ùå √âchec backend:', donnees.error);
                    
                    if (donnees.diagnostic) {
                        console.log('üîç Diagnostic disponible:', donnees.diagnostic);
                        
                        if (donnees.diagnostic.feuillesDisponibles) {
                            console.log('üìã Feuilles disponibles:', donnees.diagnostic.feuillesDisponibles);
                        }
                    }
                    
                    throw new Error(donnees.error || 'Erreur backend inconnue');
                }
                
                if (!Array.isArray(donnees.eleves) || !Array.isArray(donnees.typesProduction)) {
                    throw new Error('Structure de donn√©es backend invalide');
                }
                
                // 1. Charger les types de production
                const select = document.getElementById('productionSelect');
                select.innerHTML = '<option value="">S√©lectionner un type</option>';
                
                let typesAjoutes = 0;
                donnees.typesProduction.forEach(type => {
                    if (type && type.trim() !== '') {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        select.appendChild(option);
                        typesAjoutes++;
                    }
                });
                
                console.log(`‚úÖ ${typesAjoutes} types de production charg√©s`);
                
                // 2. Charger les √©l√®ves
                elevesData = donnees.eleves;
                const datalist = document.getElementById('elevesList');
                datalist.innerHTML = '';
                
                let elevesAjoutes = 0;
                donnees.eleves.forEach(eleve => {
                    if (eleve && eleve.nom && eleve.nom.trim() !== '') {
                        const option = document.createElement('option');
                        option.value = eleve.nom.trim();
                        datalist.appendChild(option);
                        elevesAjoutes++;
                    }
                });
                
                console.log(`‚úÖ ${elevesAjoutes} √©l√®ves charg√©s`);
                
                if (typesAjoutes === 0) {
                    throw new Error('Aucun type de production trouv√©');
                }
                
                if (elevesAjoutes === 0) {
                    console.warn('‚ö†Ô∏è Aucun √©l√®ve trouv√©, mais on continue...');
                }
                
                console.log(`üéâ Chargement group√© r√©ussi: ${elevesAjoutes} √©l√®ves + ${typesAjoutes} types`);
                return true;
                
            } catch (error) {
                console.error('‚ùå Erreur chargement group√©:', error);
                throw error;
            }
        }

        function setupEventListeners() {
            const eleveInput = document.getElementById('eleveInput');
            const productionSelect = document.getElementById('productionSelect');
            const btnReinitialisation = document.getElementById('btnReinitialisation');
            const btnSauvegarder = document.getElementById('btnSauvegarder');
            const btnPrecorrection = document.getElementById('btnPrecorrection');
            const btnPropositionCommentaire = document.getElementById('btnPropositionCommentaire');
            const btnAmeliorationCommentaire = document.getElementById('btnAmeliorationCommentaire');
            
            const precorrectionOverlay = document.getElementById('precorrectionOverlay');
            const precorrectionPanel = document.getElementById('precorrectionPanel');
            const closePrecorrectionPanel = document.getElementById('closePrecorrectionPanel');
            const lancerPrecorrection = document.getElementById('lancerPrecorrection');
            
            function checkAndLoadGrid() {
                const productionSelected = productionSelect.value !== '';
                selectedEleve = eleveInput.value.trim();
                
                if (productionSelected) {
                    chargerGrilleCorrection();
                }
            }
            
            eleveInput.addEventListener('input', function() {
                selectedEleve = this.value.trim();
            });
            
            productionSelect.addEventListener('change', checkAndLoadGrid);
            
            btnReinitialisation.addEventListener('click', function() {
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 150);
                
                if (confirm('√ätes-vous s√ªr de vouloir tout r√©initialiser ? Toutes les donn√©es non sauvegard√©es seront perdues.')) {
                    reinitialiserComplet();
                }
            });
            
            btnSauvegarder.addEventListener('click', function() {
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 150);
                
                const texteActuel = this.textContent.trim();
                
                if (texteActuel.includes('Sauvegarder')) {
                    const hasCorrections = Object.values(corrections).some(c => c.selected !== null);
                    if (!hasCorrections) {
                        showError('Veuillez effectuer au moins une correction avant de sauvegarder');
                        return;
                    }
                    enregistrerCorrection();
                } else {
                    reinitialiserComplet();
                }
            });
            
            btnPrecorrection.addEventListener('click', function() {
                if (!grilleData) {
                    showError('Veuillez d\'abord s√©lectionner un type de production');
                    return;
                }
                
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 150);
                
                ouvrirPanneauPrecorrection();
            });
            
            closePrecorrectionPanel.addEventListener('click', fermerPanneauPrecorrection);
            precorrectionOverlay.addEventListener('click', function(e) {
                if (e.target === precorrectionOverlay) {
                    fermerPanneauPrecorrection();
                }
            });
            
            lancerPrecorrection.addEventListener('click', async function() {
                const copieTexte = document.getElementById('copieEleveText').value.trim();
                
                if (!copieTexte) {
                    afficherStatusPrecorrection('Veuillez saisir le texte de la copie de l\'√©l√®ve', 'error');
                    return;
                }
                
                await executerPrecorrectionIA(copieTexte);
            });
            
            btnPropositionCommentaire.addEventListener('click', function() {
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 150);
                console.log('Bouton Proposition commentaire cliqu√© - fonctionnalit√© √† impl√©menter');
            });
            
            btnAmeliorationCommentaire.addEventListener('click', function() {
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 150);
                console.log('Bouton Am√©lioration commentaire cliqu√© - fonctionnalit√© √† impl√©menter');
            });
        }

        async function chargerGrilleCorrection() {
            const typeProduction = document.getElementById('productionSelect').value;
            if (!typeProduction) return;
            
            showLoading(true);
            
            try {
                grilleData = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .getGrilleCorrection(typeProduction);
                });
                
                if (grilleData) {
                    afficherGrille();
                    document.getElementById('grilleSection').style.display = 'block';
                    document.getElementById('saveSection').style.display = 'block';
                } else {
                    showError('Impossible de charger la grille de correction');
                }
            } catch (error) {
                console.error('Erreur chargement grille:', error);
                showError('Erreur lors du chargement de la grille');
            } finally {
                showLoading(false);
            }
        }

        function afficherGrille() {
            const container = document.getElementById('grilleContainer');
            container.innerHTML = '';
            corrections = {};
            
            grilleData.criteres.forEach((critere, critereIndex) => {
                // ‚úÖ DEBUG pour les crit√®res probl√©matiques
                if (critereIndex === 6 || critereIndex === 9) {
                    console.log(`üîç DEBUG GRILLE - Crit√®re ${critereIndex} (${critere.nom}):`);
                    console.log(`üìã Indicateurs re√ßus:`, critere.indicateurs);
                    critere.indicateurs.forEach((indicateur, index) => {
                        const isEmpty = !indicateur || indicateur.toString().trim() === '';
                        console.log(`  Index ${index}: "${indicateur}" ${isEmpty ? '(VIDE)' : ''}`);
                    });
                    console.log(`üìä Points maximum: ${critere.points}`);
                }
                
                const critereCard = document.createElement('div');
                critereCard.className = 'critere-card';
                
                const scoreIndicator = document.createElement('div');
                scoreIndicator.className = 'critere-score empty';
                scoreIndicator.textContent = '0/' + critere.points;
                scoreIndicator.id = `score-${critereIndex}`;
                
                const header = document.createElement('div');
                header.className = 'critere-header';
                header.innerHTML = `
                    <div class="critere-nom">${critere.nom}</div>
                    <div class="critere-points">Maximum: ${critere.points} points</div>
                `;
                header.appendChild(scoreIndicator);
                
                const indicateursGrid = document.createElement('div');
                indicateursGrid.className = 'indicateurs-grid';
                
                const pourcentagesParColonne = [0, 15, 35, 60, 80, 100];
                
                
                critere.indicateurs.forEach((indicateur, indicateurIndex) => {
    if (indicateur && indicateur.toString().trim() !== '') {
        const btn = document.createElement('button');
        btn.className = 'indicateur-btn';
        btn.textContent = indicateur.toString().trim();
        
        // ‚úÖ DEBUG SP√âCIAL pour le crit√®re ponctuation
        if (critereIndex === 9) {
            console.log(`üéØ CR√âATION Bouton ${indicateurIndex} pour crit√®re 9: "${btn.textContent}"`);
        }
        
        const pourcentage = pourcentagesParColonne[indicateurIndex] || 0;
        const pointsCalcules = (critere.points * pourcentage / 100);
        
        const niveaux = ['N√©ant', 'Tr√®s insuffisant', 'Insuffisant', 'Suffisant', 'Acquis', 'Parfaitement acquis'];
        const nomNiveau = niveaux[indicateurIndex] || 'Inconnu';
        
        btn.title = `${nomNiveau}: ${indicateur} (${pourcentage}% = ${pointsCalcules.toFixed(1)} pts)`;
        btn.onclick = () => selectionnerIndicateur(critereIndex, indicateurIndex, btn, critere.points, pourcentage, indicateur);
        
        indicateursGrid.appendChild(btn);
    }
});
                
                
                
                
                
                critereCard.appendChild(header);
                critereCard.appendChild(indicateursGrid);
                container.appendChild(critereCard);
                
                corrections[critereIndex] = {
                    selected: null,
                    indicateur: '',
                    points: 0,
                    pointsMax: critere.points
                };
            });
            
            mettreAJourPointsTotal();
        }

        function selectionnerIndicateur(critereIndex, indicateurIndex, btn, pointsMax, pourcentage, indicateurTexte) {
            const indicateursGrid = btn.parentNode;
            
            // V√©rifier si ce bouton est d√©j√† s√©lectionn√©
            const dejaSelectionne = btn.classList.contains('selected');
            
            // D√©s√©lectionner tous les boutons de ce crit√®re
            indicateursGrid.querySelectorAll('.indicateur-btn').forEach(b => {
                b.classList.remove('selected', 'niveau-faible', 'niveau-bon');
            });
            
            if (dejaSelectionne) {
                // ‚úÖ D√âS√âLECTION : Re-cliquer sur le m√™me bouton = d√©s√©lectionner
                corrections[critereIndex] = {
                    selected: null,
                    indicateur: '',
                    points: 0,
                    pointsMax: pointsMax
                };
                
                // Remettre le score √† 0
                const scoreIndicator = document.getElementById(`score-${critereIndex}`);
                scoreIndicator.textContent = `0/${pointsMax}`;
                scoreIndicator.classList.add('empty');
                
                console.log(`Crit√®re ${critereIndex} d√©s√©lectionn√©`);
                
            } else {
                // ‚úÖ S√âLECTION NORMALE : Nouveau bouton cliqu√©
                btn.classList.add('selected');
                
                // ‚úÖ CORRECTION : Logique de couleur coh√©rente bas√©e sur l'INDEX
                // Index 0,1,2 = Rouge (N√©ant, Tr√®s insuffisant, Insuffisant)  
                // Index 3,4,5 = Vert (Suffisant, Acquis, Parfaitement acquis)
                if (indicateurIndex < 3) {
                    btn.classList.add('niveau-faible');
                } else {
                    btn.classList.add('niveau-bon');
                }
                
                const pointsObtenus = (pointsMax * pourcentage / 100);
                
                corrections[critereIndex] = {
                    selected: indicateurIndex,
                    indicateur: indicateurTexte,
                    points: pointsObtenus,
                    pointsMax: pointsMax,
                    pourcentage: pourcentage
                };
                
                // Mettre √† jour le score affich√©
                const scoreIndicator = document.getElementById(`score-${critereIndex}`);
                scoreIndicator.textContent = `${pointsObtenus.toFixed(1)}/${pointsMax}`;
                scoreIndicator.classList.remove('empty');
                
                // Effet de pression
                btn.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    btn.style.transform = 'scale(1.02)';
                }, 150);
                
                console.log(`Crit√®re ${critereIndex} s√©lectionn√©: ${indicateurTexte}`);
            }
            
            // Mettre √† jour le total dans tous les cas
            mettreAJourPointsTotal();
        }

        function mettreAJourPointsTotal() {
            pointsTotal = 0;
            let pointsMaxTotal = 0;
            
            Object.values(corrections).forEach(correction => {
                if (correction.selected !== null) {
                    pointsTotal += correction.points;
                    pointsMaxTotal += correction.pointsMax;
                }
            });
            
            const pointsFormate = pointsTotal.toFixed(1);
            
            const pointsTotalValeur = document.getElementById('pointsTotalValeur');
            const pointsTotalFixe = document.getElementById('pointsTotalFixe');
            
            if (pointsTotalValeur && pointsTotalFixe) {
                pointsTotalValeur.textContent = `${pointsFormate} / ${pointsMaxTotal}`;
                pointsTotalFixe.style.display = 'block';
                
                pointsTotalValeur.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    pointsTotalValeur.style.transform = 'scale(1)';
                }, 200);
            }
            
            console.log('Points total mis √† jour:', pointsFormate, '/', pointsMaxTotal, '(crit√®res cot√©s seulement)');
        }

        async function enregistrerCorrection() {
            const typeProduction = document.getElementById('productionSelect').value;
            const commentairesGeneraux = document.getElementById('commentairesGeneraux').value;
            
            if (!typeProduction) {
                showError('Veuillez s√©lectionner un type de production');
                return;
            }
            
            const hasCorrections = Object.values(corrections).some(c => c.selected !== null);
            if (!hasCorrections) {
                showError('Veuillez effectuer au moins une correction');
                return;
            }
            
            if (!selectedEleve) {
                const confirmation = prompt('Aucun √©l√®ve s√©lectionn√©. Entrez un nom pour le fichier de correction:');
                if (!confirmation || confirmation.trim() === '') {
                    showError('Correction annul√©e - nom requis');
                    return;
                }
                selectedEleve = confirmation.trim();
            }
            
            const correctionsFinales = {
                ...corrections,
                commentairesGeneraux: commentairesGeneraux,
                dateCorrection: new Date().toISOString()
            };
            
            showLoading(true);
            
            try {
                const result = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .enregistrerCorrection(selectedEleve, typeProduction, correctionsFinales, pointsTotal);
                });
                
                if (result.success) {
                    showSuccessPersistant(`${result.message}<br><a href="${result.url}" target="_blank" style="color: #1a73e8; text-decoration: none;">üìÑ Ouvrir le fichier de correction</a>`);
                    changerBoutonVersNouvelleCorrection();
                } else {
                    showErrorPersistant(result.message || 'Erreur lors de l\'enregistrement');
                }
            } catch (error) {
                console.error('Erreur enregistrement:', error);
                showErrorPersistant('Erreur lors de l\'enregistrement de la correction');
            } finally {
                showLoading(false);
            }
        }

        function changerBoutonVersNouvelleCorrection() {
            const btnSauvegarder = document.getElementById('btnSauvegarder');
            btnSauvegarder.innerHTML = 'üîÑ Nouvelle correction';
            
            btnSauvegarder.style.transform = 'scale(1.05)';
            setTimeout(() => {
                btnSauvegarder.style.transform = 'scale(1)';
            }, 300);
        }

        function changerBoutonVersSauvegarder() {
            const btnSauvegarder = document.getElementById('btnSauvegarder');
            btnSauvegarder.innerHTML = 'üíæ Sauvegarder la correction';
        }

        function reinitialiserComplet() {
            document.getElementById('eleveInput').value = '';
            document.getElementById('productionSelect').value = '';
            document.getElementById('commentairesGeneraux').value = '';
            
            document.getElementById('copieEleveText').value = '';
            fermerPanneauPrecorrection();
            masquerStatusPrecorrection();
            
            selectedEleve = '';
            
            document.getElementById('grilleSection').style.display = 'none';
            document.getElementById('saveSection').style.display = 'none';
            
            document.getElementById('pointsTotalFixe').style.display = 'none';
            document.getElementById('pointsTotalValeur').textContent = '0';
            
            grilleData = null;
            corrections = {};
            pointsTotal = 0;
            
            document.getElementById('saveStatus').innerHTML = '';
            document.getElementById('saveStatus').className = 'save-status';
            
            changerBoutonVersSauvegarder();
            
            showSuccessDiscret('üîÑ R√©initialisation compl√®te effectu√©e');
        }

        function showSuccessPersistant(message) {
            const status = document.getElementById('saveStatus');
            status.className = 'save-status success';
            status.innerHTML = `‚úÖ ${message}`;
            status.style.display = 'block';
        }

        function showErrorPersistant(message) {
            const status = document.getElementById('saveStatus');
            status.className = 'save-status error';
            status.innerHTML = `‚ùå ${message}`;
            status.style.display = 'block';
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function showError(message) {
            const status = document.getElementById('saveStatus');
            status.className = 'save-status error';
            status.innerHTML = `‚ùå ${message}`;
            
            setTimeout(() => {
                status.innerHTML = '';
                status.className = 'save-status';
            }, 8000);
        }

        function showSuccess(message) {
            const status = document.getElementById('saveStatus');
            status.className = 'save-status success';
            status.innerHTML = `‚úÖ ${message}`;
            
            setTimeout(() => {
                status.innerHTML = '';
                status.className = 'save-status';
            }, 5000);
        }

        function showSuccessDiscret(message) {
            const status = document.getElementById('saveStatus');
            const originalDisplay = status.style.display;
            
            status.className = 'save-status success';
            status.innerHTML = message;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.innerHTML = '';
                status.className = 'save-status';
                status.style.display = originalDisplay;
            }, 3000);
        }

        function ouvrirPanneauPrecorrection() {
            const overlay = document.getElementById('precorrectionOverlay');
            const panel = document.getElementById('precorrectionPanel');
            
            overlay.classList.add('active');
            panel.classList.add('active');
            
            setTimeout(() => {
                document.getElementById('copieEleveText').focus();
            }, 400);
        }

        function fermerPanneauPrecorrection() {
            const overlay = document.getElementById('precorrectionOverlay');
            const panel = document.getElementById('precorrectionPanel');
            
            panel.classList.remove('active');
            setTimeout(() => {
                overlay.classList.remove('active');
            }, 300);
        }

        function afficherStatusPrecorrection(message, type = 'loading') {
            const status = document.getElementById('precorrectionStatus');
            status.className = `precorrection-status ${type}`;
            status.innerHTML = message;
            status.style.display = 'block';
        }

        function masquerStatusPrecorrection() {
            const status = document.getElementById('precorrectionStatus');
            status.style.display = 'none';
        }

        async function executerPrecorrectionIA(copieTexte) {
            const btnLancer = document.getElementById('lancerPrecorrection');
            const typeProduction = document.getElementById('productionSelect').value;
            
            try {
                btnLancer.disabled = true;
                afficherStatusPrecorrection('ü§ñ L\'IA analyse la copie...', 'loading');
                
                console.log('Envoi de la copie √† l\'IA pour pr√©correction...');
                
                const resultatIA = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .precorrectionIA(typeProduction, grilleData, copieTexte);
                });
                
                if (resultatIA.success) {
                    afficherStatusPrecorrection('‚úÖ Pr√©correction termin√©e ! Application en cours...', 'success');
                    
                    appliquerCorrectionsIA(resultatIA.corrections);
                    
                    if (resultatIA.commentaire_final) {
                        document.getElementById('commentairesGeneraux').value = resultatIA.commentaire_final;
                    }
                    
                    setTimeout(() => {
                        fermerPanneauPrecorrection();
                        showSuccessDiscret('ü§ñ Pr√©correction IA appliqu√©e avec succ√®s !');
                    }, 2000);
                    
                } else {
                    afficherStatusPrecorrection(`‚ùå Erreur: ${resultatIA.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Erreur pr√©correction IA:', error);
                afficherStatusPrecorrection('‚ùå Erreur de communication avec l\'IA', 'error');
            } finally {
                btnLancer.disabled = false;
            }
        }

        function appliquerCorrectionsIA(correctionsIA) {
    console.log('ü§ñ D√âBUT Application des corrections IA:', correctionsIA);
    
    // R√©initialiser les corrections actuelles
    Object.keys(corrections).forEach(critereIndex => {
        corrections[critereIndex] = {
            selected: null,
            indicateur: '',
            points: 0,
            pointsMax: corrections[critereIndex].pointsMax
        };
    });
    
    // ‚úÖ NOUVELLE LOGIQUE : Appliquer chaque correction de l'IA
    Object.keys(correctionsIA).forEach(critereIndex => {
        const correctionIA = correctionsIA[critereIndex];
        const critere = grilleData.criteres[parseInt(critereIndex)];
        
        console.log(`üîç TRAITEMENT Crit√®re ${critereIndex}:`, correctionIA);
        
        if (critere && correctionIA.indicateur) {
            console.log(`üìù Crit√®re ${critereIndex} - Indicateur IA: "${correctionIA.indicateur}"`);
            console.log(`üìù Crit√®re ${critereIndex} - Pourcentage IA: ${correctionIA.pourcentage}%`);
            
            // Trouver l'indicateur correspondant - RECHERCHE PLUS ROBUSTE
            let indicateurIndex = -1;
            const indicateurRecherche = correctionIA.indicateur.toString().trim();
            
            console.log(`üîé Recherche de: "${indicateurRecherche}"`);
            console.log(`üîé Dans les indicateurs:`, critere.indicateurs);
            
            for (let i = 0; i < critere.indicateurs.length; i++) {
                const indicateurGrille = critere.indicateurs[i];
                console.log(`üîé Comparaison ${i}: "${indicateurGrille}" VS "${indicateurRecherche}"`);
                if (indicateurGrille && indicateurGrille.toString().trim() === indicateurRecherche) {
                    indicateurIndex = i;
                    break;
                }
            }
            
            console.log(`‚úÖ Indicateur "${indicateurRecherche}" trouv√© √† l'index:`, indicateurIndex);
            
            if (indicateurIndex !== -1) {
                // ‚úÖ CALCUL COH√âRENT des pourcentages - IGNORER COMPL√àTEMENT le pourcentage IA
                const pourcentagesParColonne = [0, 15, 35, 60, 80, 100];
                const pourcentageCorrect = pourcentagesParColonne[indicateurIndex] || 0;
                const pointsObtenus = (critere.points * pourcentageCorrect / 100);
                
                console.log(`üîç DEBUG Crit√®re ${critereIndex}:`);
                console.log(`- Index trouv√©: ${indicateurIndex}`);
                console.log(`- Pourcentage IA re√ßu: ${correctionIA.pourcentage}% (IGNOR√â)`);
                console.log(`- Pourcentage FORC√â selon index ${indicateurIndex}: ${pourcentageCorrect}%`);
                console.log(`- Points FORC√âS: ${pointsObtenus.toFixed(1)}/${critere.points}`);
                
                // ‚úÖ FORCER l'affichage dans l'interface aussi
                if (critereIndex == "9") { // Crit√®re ponctuation sp√©cifiquement
                    console.log(`üö® PONCTUATION - Indicateur: "${correctionIA.indicateur}"`);
                    console.log(`üö® PONCTUATION - Index: ${indicateurIndex}`);
                    console.log(`üö® PONCTUATION - Points FORC√âS: ${pointsObtenus.toFixed(1)} (au lieu de 1.8)`);
                    console.log(`üö® PONCTUATION - Couleur: ${indicateurIndex < 3 ? 'ROUGE' : 'VERT'}`);
                }
                
                // Mettre √† jour les corrections
                corrections[critereIndex] = {
                    selected: indicateurIndex,
                    indicateur: correctionIA.indicateur,
                    points: pointsObtenus,
                    pointsMax: critere.points,
                    pourcentage: pourcentageCorrect, // ‚úÖ Utiliser le pourcentage CORRECT bas√© sur l'index
                    justificationIA: correctionIA.justification
                };
                
                // ‚úÖ MISE √Ä JOUR VISUELLE COMPL√àTE
                const critereCard = document.querySelector(`#score-${critereIndex}`);
                if (critereCard) {
                    const critereContainer = critereCard.closest('.critere-card');
                    
                    if (critereContainer) {
                        // 1. D√©s√©lectionner tous les boutons
                        critereContainer.querySelectorAll('.indicateur-btn').forEach(btn => {
                            btn.classList.remove('selected', 'niveau-faible', 'niveau-bon');
                        });
                        
                        // 2. Trouver et s√©lectionner le bon bouton avec MAPPING CORRIG√â
                        const indicateurBtns = critereContainer.querySelectorAll('.indicateur-btn');
                        
                        // ‚úÖ NOUVEAU : Cr√©er un mapping entre index grille et position bouton
                        let indexVersPosition = {};
                        let positionVersIndex = {};
                        let positionBouton = 0;
                        
                        // Parcourir les indicateurs de la grille pour cr√©er le mapping
                        critere.indicateurs.forEach((indicateur, indexGrille) => {
                            if (indicateur && indicateur.toString().trim() !== '') {
                                indexVersPosition[indexGrille] = positionBouton;
                                positionVersIndex[positionBouton] = indexGrille;
                                positionBouton++;
                            }
                        });
                        
                        console.log(`üó∫Ô∏è MAPPING Crit√®re ${critereIndex}:`, indexVersPosition);
                        console.log(`üó∫Ô∏è Position du bouton pour index ${indicateurIndex}:`, indexVersPosition[indicateurIndex]);
                        
                        // ‚úÖ Utiliser le mapping pour trouver la bonne position
                        const positionBoutonCible = indexVersPosition[indicateurIndex];
                        
                        if (typeof positionBoutonCible !== 'undefined' && indicateurBtns[positionBoutonCible]) {
                            const btn = indicateurBtns[positionBoutonCible];
                            
                            console.log(`üéØ S√âLECTION: Index grille ${indicateurIndex} ‚Üí Position bouton ${positionBoutonCible}`);
                            console.log(`üéØ Texte du bouton s√©lectionn√©: "${btn.textContent}"`);
                            
                            // ‚úÖ APPLIQUER LA S√âLECTION
                            btn.classList.add('selected');
                            
                            // ‚úÖ LOGIQUE DE COULEUR bas√©e sur l'INDEX DE LA GRILLE
                            if (indicateurIndex < 3) {
                                btn.classList.add('niveau-faible'); // Rouge : 0,1,2
                                console.log(`üî¥ Crit√®re ${critereIndex} - ROUGE (index grille ${indicateurIndex})`);
                            } else {
                                btn.classList.add('niveau-bon');    // Vert : 3,4,5
                                console.log(`üü¢ Crit√®re ${critereIndex} - VERT (index grille ${indicateurIndex})`);
                            }
                            
                            // Ajouter la justification en tooltip
                            const tooltipOriginal = btn.title || '';
                            btn.title = `${tooltipOriginal}\n\nü§ñ IA: ${correctionIA.justification}`;
                            
                            console.log(`‚úÖ Bouton position ${positionBoutonCible} (index grille ${indicateurIndex}) mis √† jour visuellement pour crit√®re ${critereIndex}`);
                            
                            // ‚úÖ DEBUG SP√âCIAL pour la ponctuation
                            if (critereIndex == "9") {
                                console.log(`üîç V√âRIFICATION FINALE PONCTUATION (CORRIG√âE):`);
                                indicateurBtns.forEach((btnVerif, position) => {
                                    const indexGrilleCorrespondant = positionVersIndex[position];
                                    const isSelected = btnVerif.classList.contains('selected');
                                    const color = btnVerif.classList.contains('niveau-faible') ? 'ROUGE' : 
                                                 btnVerif.classList.contains('niveau-bon') ? 'VERT' : 'AUCUNE';
                                    console.log(`  Position ${position} (index grille ${indexGrilleCorrespondant}): "${btnVerif.textContent}" - S√©lectionn√©: ${isSelected} - Couleur: ${color}`);
                                });
                            }
                            
                        } else {
                            // ‚úÖ GESTION d'erreur avec fallback
                            console.error(`‚ùå Position bouton introuvable pour l'index grille ${indicateurIndex} du crit√®re ${critereIndex}`);
                            console.log(`üîç Mapping disponible:`, indexVersPosition);
                            console.log(`üîç Nombre de boutons disponibles: ${indicateurBtns.length}`);
                            console.log(`üîç Index demand√©: ${indicateurIndex}`);
                            
                            // ‚úÖ FALLBACK : Utiliser le dernier bouton disponible
                            if (indicateurBtns.length > 0) {
                                const dernierPosition = indicateurBtns.length - 1;
                                const btn = indicateurBtns[dernierPosition];
                                const dernierIndexGrille = positionVersIndex[dernierPosition];
                                
                                console.log(`üîß FALLBACK: Utilisation position ${dernierPosition} (index grille ${dernierIndexGrille}) au lieu de index grille ${indicateurIndex}`);
                                
                                btn.classList.add('selected');
                                if (dernierIndexGrille < 3) {
                                    btn.classList.add('niveau-faible');
                                } else {
                                    btn.classList.add('niveau-bon');
                                }
                                
                                // Mettre √† jour les corrections avec l'index corrig√©
                                corrections[critereIndex].selected = dernierIndexGrille;
                                
                                // Recalculer les points avec le bon pourcentage
                                const pourcentagesParColonne = [0, 15, 35, 60, 80, 100];
                                const nouveauPourcentage = pourcentagesParColonne[dernierIndexGrille] || 0;
                                const nouveauxPoints = (critere.points * nouveauPourcentage / 100);
                                corrections[critereIndex].points = nouveauxPoints;
                                corrections[critereIndex].pourcentage = nouveauPourcentage;
                                
                                console.log(`üîß Points recalcul√©s: ${nouveauxPoints.toFixed(1)}/${critere.points}`);
                            }
                        }
                        
                        // 3. Mettre √† jour le score affich√©
                        const scoreIndicator = document.getElementById(`score-${critereIndex}`);
                        if (scoreIndicator) {
                            scoreIndicator.textContent = `${corrections[critereIndex].points.toFixed(1)}/${critere.points}`;
                            scoreIndicator.classList.remove('empty');
                            console.log(`üìä Score mis √† jour pour crit√®re ${critereIndex}: ${corrections[critereIndex].points.toFixed(1)}/${critere.points}`);
                        }
                    }
                }
            } else {
                console.error(`‚ùå Indicateur IA non trouv√©: "${indicateurRecherche}" pour le crit√®re ${critereIndex}`);
                console.log('Indicateurs disponibles:', critere.indicateurs);
            }
        }
    });
    
    // Mettre √† jour le total
    mettreAJourPointsTotal();
    
    console.log('‚úÖ Application des corrections IA termin√©e');
}

        // Raccourcis clavier
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === 's') {
                event.preventDefault();
            }
            
            if (event.ctrlKey && event.key === 'Enter') {
                event.preventDefault();
                enregistrerCorrection();
            }
            
            if (event.key === 'Escape') {
                if (confirm('Voulez-vous r√©initialiser la correction en cours ?')) {
                    reinitialiserComplet();
                }
            }
        });
</script>
</body>
</html>
